# ğŸ“‹ 7ty.vn CRM - Há»‡ Thá»‘ng Quáº£n LÃ½ KhÃ¡ch HÃ ng Tá»•ng Há»£p

## ğŸ¯ **Tá»”NG QUAN Há»† THá»NG**

**7ty.vn CRM** lÃ  má»™t há»‡ thá»‘ng quáº£n lÃ½ khÃ¡ch hÃ ng (Customer Relationship Management) toÃ n diá»‡n Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘áº·c biá»‡t cho viá»‡c quáº£n lÃ½ bills Ä‘iá»‡n, tháº» tÃ­n dá»¥ng vÃ  giao dá»‹ch tÃ i chÃ­nh. Há»‡ thá»‘ng cung cáº¥p giáº£i phÃ¡p one-stop cho viá»‡c quáº£n lÃ½ customer lifecycle tá»« A-Z.

### **ğŸ—ï¸ KIáº¾N TRÃšC Tá»”NG QUAN**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FRONTEND      â”‚â—„â”€â”€â–ºâ”‚    BACKEND      â”‚â—„â”€â”€â–ºâ”‚    DATABASE     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ React + Vite    â”‚    â”‚ FastAPI Python  â”‚    â”‚   MongoDB       â”‚
â”‚ TailwindCSS     â”‚    â”‚ JWT Auth        â”‚    â”‚ NoSQL Document  â”‚
â”‚ Shadcn UI       â”‚    â”‚ Role-Based      â”‚    â”‚ Collections     â”‚
â”‚ Recharts        â”‚    â”‚ Access Control  â”‚    â”‚ Aggregation     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒŸ **TÃNH NÄ‚NG CHÃNH**

### **1. ğŸ  Dashboard & Analytics**
- **Real-time KPI Monitoring**: Theo dÃµi doanh thu, lá»£i nhuáº­n, sá»‘ lÆ°á»£ng giao dá»‹ch
- **Interactive Charts**: Biá»ƒu Ä‘á»“ doanh thu theo thá»i gian, phÃ¢n bá»‘ giao dá»‹ch
- **Quick Actions**: 6 shortcuts nhanh Ä‘áº¿n cÃ¡c tÃ­nh nÄƒng chÃ­nh
- **Activity Feed**: Luá»“ng hoáº¡t Ä‘á»™ng real-time cá»§a há»‡ thá»‘ng
- **Customer Insights**: PhÃ¢n tÃ­ch hÃ nh vi vÃ  giÃ¡ trá»‹ khÃ¡ch hÃ ng

### **2. ğŸ‘¥ Quáº£n LÃ½ KhÃ¡ch HÃ ng**
- **Customer 360Â° View**: CÃ¡i nhÃ¬n toÃ n diá»‡n vá» khÃ¡ch hÃ ng qua 4 tabs
- **Advanced Search & Filter**: TÃ¬m kiáº¿m theo nhiá»u tiÃªu chÃ­
- **Bulk Operations**: Chá»n nhiá»u khÃ¡ch hÃ ng, xÃ³a/xuáº¥t hÃ ng loáº¡t
- **Transaction History**: Lá»‹ch sá»­ giao dá»‹ch chi tiáº¿t
- **Performance Analytics**: PhÃ¢n tÃ­ch hiá»‡u suáº¥t vÃ  giÃ¡ trá»‹ khÃ¡ch hÃ ng

### **3. ğŸ“„ Quáº£n LÃ½ Bills Äiá»‡n**
- **Multi-provider Support**: Há»— trá»£ Miá»n Báº¯c, Miá»n Nam, TP.HCM
- **Batch Bill Checking**: Kiá»ƒm tra hÃ ng loáº¡t bills qua API
- **Smart Status Management**: AVAILABLE, SOLD, CROSSED, ERROR
- **Inventory Management**: Quáº£n lÃ½ kho bills vá»›i dual-tab logic
- **Real-time Validation**: Kiá»ƒm tra real-time qua external APIs

### **4. ğŸ’³ Quáº£n LÃ½ Tháº» TÃ­n Dá»¥ng**
- **3D Card UI**: Giao diá»‡n tháº» 3D chÃ¢n thá»±c
- **ÄÃO Functionality**: ÄÃ¡o tháº» qua POS hoáº·c BILL
- **Cycle Management**: Quáº£n lÃ½ chu ká»³ thanh toÃ¡n
- **Multi-bank Support**: Há»— trá»£ nhiá»u ngÃ¢n hÃ ng
- **Status Tracking**: Theo dÃµi tráº¡ng thÃ¡i tháº» real-time

### **5. ğŸ’¼ Quáº£n LÃ½ Giao Dá»‹ch**
- **Unified Transaction View**: Tá»•ng há»£p táº¥t cáº£ loáº¡i giao dá»‹ch
- **Advanced Filtering**: Lá»c theo type, date, status, amount
- **Financial Analytics**: PhÃ¢n tÃ­ch doanh thu, lá»£i nhuáº­n
- **Export Capabilities**: Xuáº¥t bÃ¡o cÃ¡o Excel/PDF
- **Profit Tracking**: Theo dÃµi lá»£i nhuáº­n theo tá»«ng giao dá»‹ch

### **6. ğŸ“Š BÃ¡o CÃ¡o & PhÃ¢n TÃ­ch**
- **Revenue Analytics**: PhÃ¢n tÃ­ch doanh thu chi tiáº¿t
- **Customer Performance**: Hiá»‡u suáº¥t tá»«ng khÃ¡ch hÃ ng
- **Transaction Trends**: Xu hÆ°á»›ng giao dá»‹ch theo thá»i gian
- **Profitability Analysis**: PhÃ¢n tÃ­ch lá»£i nhuáº­n
- **Custom Reports**: BÃ¡o cÃ¡o tÃ¹y chá»‰nh theo nhu cáº§u

### **7. ğŸ” Authentication & Security**
- **JWT-based Authentication**: Báº£o máº­t vá»›i JSON Web Tokens
- **Role-based Access Control**: PhÃ¢n quyá»n Admin/Manager/User
- **Smart Login**: Auto-detect username/email/phone
- **Password Security**: MÃ£ hÃ³a bcrypt
- **Session Management**: Quáº£n lÃ½ phiÃªn Ä‘Äƒng nháº­p

---

## ğŸ› ï¸ **CÃ”NG NGHá»† Sá»¬ Dá»¤NG**

### **Frontend Stack**
```json
{
  "framework": "React 18.2.0",
  "build_tool": "Vite 4.4.5",
  "styling": "TailwindCSS 3.3.0",
  "ui_components": "Shadcn UI",
  "charts": "Recharts 2.7.2",
  "http_client": "Axios 1.5.0",
  "state_management": "React Context + Hooks",
  "routing": "React Router DOM 6.15.0"
}
```

### **Backend Stack**
```json
{
  "framework": "FastAPI 0.103.1",
  "language": "Python 3.11+",
  "authentication": "JWT + bcrypt",
  "validation": "Pydantic 2.3.0",
  "async_support": "AsyncIO + Motor",
  "cors": "FastAPI CORS Middleware",
  "logging": "Python logging module"
}
```

### **Database**
```json
{
  "primary_db": "MongoDB 7.0+",
  "driver": "Motor (AsyncIO MongoDB)",
  "connection": "MongoDB Atlas / Local Instance",
  "indexing": "Compound indexes for performance",
  "aggregation": "MongoDB Aggregation Pipeline"
}
```

### **Infrastructure**
```json
{
  "containerization": "Docker + Kubernetes",
  "process_management": "Supervisor",
  "reverse_proxy": "Kubernetes Ingress",
  "environment": "Cloud Container (Linux)",
  "monitoring": "Application logs + Supervisor logs"
}
```

---

## ğŸ—„ï¸ **Cáº¤U TRÃšC DATABASE**

### **Collections Overview**
```
7ty_crm_database/
â”œâ”€â”€ users/              # System users (Admin/Manager/User)
â”œâ”€â”€ customers/          # CRM customers data
â”œâ”€â”€ bills/              # Electric bills management
â”œâ”€â”€ credit_cards/       # Credit cards information
â”œâ”€â”€ credit_card_transactions/  # Credit card transactions
â”œâ”€â”€ sales/              # Sales transactions
â”œâ”€â”€ inventory_items/    # Bills in inventory
â””â”€â”€ activities/         # System activities log
```

### **Collection Schemas**

#### **1. Users Collection**
```javascript
{
  "id": "uuid4",
  "username": "string (3-50 chars)",
  "email": "EmailStr", 
  "phone": "string (10-15 digits, optional)",
  "password": "bcrypt_hashed_string",
  "full_name": "string (1-100 chars)",
  "role": "admin|manager|user",
  "is_active": "boolean",
  "created_at": "ISO_datetime",
  "updated_at": "ISO_datetime",
  "last_login": "ISO_datetime (optional)"
}
```

#### **2. Customers Collection**
```javascript
{
  "id": "uuid4",
  "type": "INDIVIDUAL|AGENT",
  "name": "string",
  "phone": "string (optional)",
  "email": "string (optional)", 
  "address": "string (optional)",
  "is_active": "boolean",
  "total_transactions": "integer",
  "total_value": "float",
  "total_bills": "integer",
  "total_cards": "integer", 
  "total_profit_generated": "float",
  "notes": "string (optional)",
  "created_at": "ISO_datetime",
  "updated_at": "ISO_datetime"
}
```

#### **3. Bills Collection**
```javascript
{
  "id": "uuid4",
  "customer_code": "string",
  "provider_region": "MIEN_BAC|MIEN_NAM|HCMC",
  "full_name": "string",
  "address": "string",
  "amount": "float",
  "due_date": "ISO_datetime",
  "billing_cycle": "string",
  "status": "AVAILABLE|PENDING|SOLD|CROSSED|ERROR",
  "raw_status": "string",
  "is_valid": "boolean",
  "created_at": "ISO_datetime",
  "updated_at": "ISO_datetime",
  "last_checked": "ISO_datetime (optional)"
}
```

#### **4. Credit Cards Collection**
```javascript
{
  "id": "uuid4",
  "customer_id": "uuid4_reference",
  "card_number": "string",
  "bank_name": "string", 
  "card_type": "VISA|MASTERCARD|JCB",
  "credit_limit": "float",
  "current_balance": "float",
  "minimum_payment": "float",
  "due_date": "ISO_datetime",
  "status": "ChÆ°a Ä‘áº¿n háº¡n|Cáº§n Ä‘Ã¡o|ÄÃ£ Ä‘Ã¡o|QuÃ¡ Háº¡n",
  "grace_period_end": "ISO_datetime",
  "current_cycle_month": "string",
  "cycle_payment_count": "integer",
  "last_payment_date": "ISO_datetime (optional)",
  "created_at": "ISO_datetime",
  "updated_at": "ISO_datetime"
}
```

#### **5. Credit Card Transactions Collection**
```javascript
{
  "id": "uuid4", 
  "card_id": "uuid4_reference",
  "customer_id": "uuid4_reference",
  "transaction_group_id": "string",
  "transaction_type": "CREDIT_CARD_PAYMENT",
  "payment_method": "POS|BILL",
  "total_amount": "float",
  "profit_pct": "float",
  "profit_value": "float", 
  "payback": "float",
  "bill_ids": "array[uuid4] (optional)",
  "notes": "string (optional)",
  "status": "COMPLETED",
  "created_at": "ISO_datetime"
}
```

#### **6. Sales Collection**
```javascript
{
  "id": "uuid4",
  "customer_id": "uuid4_reference",
  "transaction_type": "BILL_SALE|CREDIT_CARD",
  "total": "float",
  "profit_pct": "float",
  "profit_value": "float",
  "payback": "float", 
  "method": "CASH|BANK_TRANSFER|OTHER",
  "status": "COMPLETED|PENDING|FAILED",
  "bill_ids": "array[uuid4] (optional)",
  "notes": "string (optional)",
  "created_at": "ISO_datetime"
}
```

#### **7. Activities Collection**
```javascript
{
  "id": "uuid4",
  "type": "CUSTOMER_CREATE|BILL_SALE|CARD_PAYMENT_POS|...", 
  "title": "string",
  "description": "string",
  "customer_id": "uuid4_reference (optional)",
  "customer_name": "string (optional)",
  "amount": "float (optional)",
  "status": "SUCCESS|ERROR", 
  "metadata": "object (optional)",
  "created_at": "ISO_datetime"
}
```

---

## ğŸ”Œ **API DOCUMENTATION**

### **Base Configuration**
```
Base URL: https://[domain]/api
Authentication: Bearer JWT Token
Content-Type: application/json
CORS: Enabled for frontend origin
```

### **Authentication Endpoints**

#### **POST /auth/register**
**MÃ´ táº£**: ÄÄƒng kÃ½ user má»›i
```javascript
// Request
{
  "username": "string (3-50)",
  "email": "valid_email", 
  "phone": "string (10-15, optional)",
  "password": "string (6+)",
  "full_name": "string (1-100)",
  "role": "admin|manager|user"
}

// Response 200
{
  "id": "uuid4",
  "username": "string",
  "email": "string", 
  "phone": "string",
  "full_name": "string",
  "role": "string",
  "is_active": true,
  "created_at": "ISO_datetime"
}
```

#### **POST /auth/login**
**MÃ´ táº£**: ÄÄƒng nháº­p (username/email/phone auto-detect)
```javascript
// Request
{
  "login": "username_or_email_or_phone",
  "password": "string"
}

// Response 200
{
  "access_token": "jwt_token_string",
  "token_type": "bearer",
  "user": {
    "id": "uuid4",
    "username": "string",
    "email": "string",
    "phone": "string", 
    "full_name": "string",
    "role": "string",
    "last_login": "ISO_datetime"
  }
}
```

#### **GET /auth/me**
**MÃ´ táº£**: Láº¥y thÃ´ng tin user hiá»‡n táº¡i
**Headers**: `Authorization: Bearer {token}`
```javascript
// Response 200
{
  "id": "uuid4",
  "username": "string", 
  "email": "string",
  "phone": "string",
  "full_name": "string",
  "role": "string",
  "is_active": "boolean",
  "created_at": "ISO_datetime",
  "last_login": "ISO_datetime"
}
```

### **Customer Management Endpoints**

#### **GET /customers**
**MÃ´ táº£**: Láº¥y danh sÃ¡ch customers vá»›i filter
**Query Parameters**: 
- `search` (optional): TÃ¬m kiáº¿m theo tÃªn/phone
- `customer_type` (optional): INDIVIDUAL/AGENT
- `is_active` (optional): true/false
- `page_size` (optional): Sá»‘ lÆ°á»£ng records

```javascript
// Response 200
[
  {
    "id": "uuid4",
    "type": "INDIVIDUAL|AGENT",
    "name": "string",
    "phone": "string",
    "email": "string",
    "address": "string", 
    "is_active": "boolean",
    "total_transactions": "integer",
    "total_value": "float",
    "total_profit_generated": "float",
    "created_at": "ISO_datetime"
  }
]
```

#### **POST /customers**
**MÃ´ táº£**: Táº¡o customer má»›i
```javascript
// Request
{
  "type": "INDIVIDUAL|AGENT",
  "name": "string (required)",
  "phone": "string (optional)", 
  "email": "string (optional)",
  "address": "string (optional)",
  "notes": "string (optional)"
}

// Response 200
{
  "id": "uuid4",
  "message": "Customer created successfully"
}
```

#### **GET /customers/stats**
**MÃ´ táº£**: Thá»‘ng kÃª customers
```javascript
// Response 200
{
  "total_customers": "integer",
  "individual_customers": "integer", 
  "agent_customers": "integer",
  "active_customers": "integer",
  "total_customer_value": "float"
}
```

### **Bills Management Endpoints**

#### **GET /bills**
**MÃ´ táº£**: Láº¥y danh sÃ¡ch bills
**Query Parameters**:
- `status` (optional): AVAILABLE/SOLD/CROSSED/ERROR
- `search` (optional): TÃ¬m theo customer_code
- `limit` (optional): Giá»›i háº¡n sá»‘ lÆ°á»£ng

```javascript
// Response 200
[
  {
    "id": "uuid4",
    "customer_code": "string",
    "provider_region": "MIEN_BAC|MIEN_NAM|HCMC", 
    "full_name": "string",
    "address": "string",
    "amount": "float",
    "due_date": "ISO_datetime",
    "status": "AVAILABLE|SOLD|CROSSED|ERROR",
    "is_valid": "boolean",
    "created_at": "ISO_datetime"
  }
]
```

#### **POST /bill/check/single**
**MÃ´ táº£**: Kiá»ƒm tra bill Ä‘Æ¡n láº»
**Query Parameters**:
- `customer_code`: MÃ£ khÃ¡ch hÃ ng
- `provider_region`: VÃ¹ng cung cáº¥p

```javascript
// Response 200
{
  "success": "boolean",
  "bill_data": {
    "customer_code": "string",
    "full_name": "string", 
    "address": "string",
    "amount": "float",
    "due_date": "ISO_datetime",
    "is_valid": "boolean"
  },
  "message": "string"
}
```

### **Credit Cards Endpoints**

#### **GET /credit-cards**
**MÃ´ táº£**: Láº¥y danh sÃ¡ch credit cards
```javascript  
// Response 200
[
  {
    "id": "uuid4",
    "customer_id": "uuid4", 
    "card_number": "string",
    "bank_name": "string",
    "card_type": "VISA|MASTERCARD|JCB",
    "credit_limit": "float",
    "status": "string",
    "due_date": "ISO_datetime",
    "customer": {
      "name": "string",
      "phone": "string"
    }
  }
]
```

#### **POST /credit-cards/{card_id}/dao**
**MÃ´ táº£**: ÄÃ¡o tháº» tÃ­n dá»¥ng (POS hoáº·c BILL)
```javascript
// Request (POS Method)
{
  "payment_method": "POS",
  "total_amount": "float (required for POS)",
  "profit_pct": "float",
  "notes": "string (optional)"
}

// Request (BILL Method)  
{
  "payment_method": "BILL",
  "bill_ids": "array[uuid4] (required for BILL)",
  "profit_pct": "float", 
  "notes": "string (optional)"
}

// Response 200
{
  "success": true,
  "message": "ÄÃ£ Ä‘Ã¡o tháº» thÃ nh cÃ´ng báº±ng phÆ°Æ¡ng thá»©c POS|BILL",
  "transaction_group_id": "string",
  "total_amount": "float",
  "profit_value": "float",
  "payback": "float"
}
```

---

## ğŸ” **Há»† THá»NG PHÃ‚N QUYá»€N**

### **Roles Overview**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ADMIN      â”‚ â† Full system access
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     MANAGER     â”‚ â† Business data access  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      USER       â”‚ â† Limited access
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Detailed Permissions Matrix**

| **Endpoint Category** | **Admin** | **Manager** | **User** |
|----------------------|-----------|-------------|----------|
| **User Management** | âœ… Full | âœ… View Only | âŒ Denied |
| **Customer Management** | âœ… Full | âœ… Full | âŒ Denied |  
| **Bills Management** | âœ… Full | âœ… Full | âŒ Denied |
| **Credit Cards** | âœ… Full | âœ… Full | âŒ Denied |
| **Inventory** | âœ… Full | âœ… Full | âŒ Denied |
| **Sales & Transactions** | âœ… Full | âœ… Full | âŒ Denied |
| **Dashboard Stats** | âœ… Full | âœ… Read | âŒ Denied |
| **Reports & Analytics** | âœ… Full | âœ… Read | âŒ Denied |
| **Profile Management** | âœ… Full | âœ… Own | âœ… Own |

### **âš ï¸ SECURITY ALERT - AUTHORIZATION BUG**
**ğŸš¨ CRITICAL**: Hiá»‡n táº¡i cÃ³ lá»— há»•ng báº£o máº­t nghiÃªm trá»ng - User role cÃ³ thá»ƒ truy cáº­p táº¥t cáº£ business data. Cáº§n fix ngay:

```python
# âŒ HIá»†N Táº I - Thiáº¿u role check
@api_router.get("/customers")
async def get_customers(...):

# âœ… Cáº¦N Sá»¬A - ThÃªm role restriction  
@api_router.get("/customers")
async def get_customers(..., current_user: dict = manager_or_admin_required):
```

---

## ğŸ“‚ **Cáº¤U TRÃšC PROJECT**

### **Directory Structure**
```
/app/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ server.py              # Main FastAPI application
â”‚   â”œâ”€â”€ requirements.txt       # Python dependencies
â”‚   â””â”€â”€ .env                  # Backend environment variables
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”œâ”€â”€ index.html        # HTML template
â”‚   â”‚   â””â”€â”€ assets/           # Static assets
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/       # React components
â”‚   â”‚   â”‚   â”œâ”€â”€ LoginPage.js  # Login component
â”‚   â”‚   â”‚   â”œâ”€â”€ ProtectedRoute.js # Route protection
â”‚   â”‚   â”‚   â””â”€â”€ UserProfile.js # User profile
â”‚   â”‚   â”œâ”€â”€ contexts/         # React contexts
â”‚   â”‚   â”‚   â””â”€â”€ AuthContext.js # Authentication context
â”‚   â”‚   â”œâ”€â”€ App.js           # Main App component  
â”‚   â”‚   â”œâ”€â”€ App.css          # Main styles
â”‚   â”‚   â”œâ”€â”€ index.js         # React entry point
â”‚   â”‚   â””â”€â”€ index.css        # Global styles
â”‚   â”œâ”€â”€ package.json         # Frontend dependencies
â”‚   â”œâ”€â”€ tailwind.config.js   # TailwindCSS configuration
â”‚   â”œâ”€â”€ postcss.config.js    # PostCSS configuration  
â”‚   â””â”€â”€ .env                 # Frontend environment variables
â”œâ”€â”€ tests/                   # Test files
â”œâ”€â”€ scripts/                 # Utility scripts
â”œâ”€â”€ test_result.md          # Testing results
â”œâ”€â”€ SYSTEM_DOCUMENTATION.md # This file
â””â”€â”€ README.md               # Project README
```

### **Key Files Description**

#### **Backend Files**
- **`server.py`**: Core FastAPI application vá»›i táº¥t cáº£ API endpoints, authentication, business logic
- **`requirements.txt`**: Python dependencies (FastAPI, Motor, PyJWT, bcrypt, etc.)
- **`.env`**: Environment variables (MONGO_URL, JWT_SECRET_KEY, etc.)

#### **Frontend Files**
- **`App.js`**: Main React component chá»©a all pages vÃ  routing logic
- **`AuthContext.js`**: Global authentication state management
- **`LoginPage.js`**: Glassmorphism login interface vá»›i 7ty.vn branding
- **`ProtectedRoute.js`**: Route wrapper cho authentication protection
- **`package.json`**: Frontend dependencies (React, TailwindCSS, Recharts, etc.)

---

## âš™ï¸ **Cáº¤U HÃŒNH & ENVIRONMENT**

### **Backend Environment (.env)**
```bash
# Database Configuration
MONGO_URL=mongodb://localhost:27017/7ty_crm_database

# JWT Configuration  
JWT_SECRET_KEY=your_super_secret_jwt_key_here
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# External API Configuration
EXTERNAL_BILL_API_URL=https://n8n.phamthanh.net/webhook/checkbill

# Application Configuration
DEBUG=False
ENVIRONMENT=production
```

### **Frontend Environment (.env)**
```bash
# Backend API Configuration
REACT_APP_BACKEND_URL=https://crm-7ty.preview.emergentagent.com

# Application Configuration
REACT_APP_NAME=7ty.vn CRM
REACT_APP_VERSION=1.0.0
```

### **Docker Configuration (Kubernetes)**
```yaml
# Service Configuration
services:
  backend:
    port: 8001
    process_manager: supervisorctl
    auto_restart: true
    
  frontend:  
    port: 3000
    build_tool: vite
    hot_reload: enabled
    
# Ingress Rules
ingress:
  - path: /api/* â†’ backend:8001
  - path: /* â†’ frontend:3000
```

---

## ğŸš€ **HÆ¯á»šNG DáºªN CÃ€I Äáº¶T**

### **Prerequisites**
- **Python 3.11+**
- **Node.js 18+** 
- **MongoDB 7.0+**
- **Docker & Kubernetes** (for containerized deployment)

### **Local Development Setup**

#### **1. Clone Repository**
```bash
git clone <repository_url>
cd 7ty-crm
```

#### **2. Backend Setup**
```bash
# Navigate to backend directory
cd backend

# Create virtual environment
python -m venv venv
source venv/bin/activate  # Linux/Mac
# or
venv\Scripts\activate     # Windows

# Install dependencies
pip install -r requirements.txt

# Configure environment
cp .env.example .env
# Edit .env vá»›i cÃ¡c giÃ¡ trá»‹ thá»±c táº¿

# Start MongoDB (local)
mongod --dbpath /path/to/data

# Run backend server
uvicorn server:app --host 0.0.0.0 --port 8001 --reload
```

#### **3. Frontend Setup** 
```bash
# Navigate to frontend directory
cd ../frontend

# Install dependencies (MUST use yarn)
yarn install

# Configure environment
cp .env.example .env
# Edit .env vá»›i REACT_APP_BACKEND_URL

# Start development server
yarn dev
```

#### **4. Database Setup**
```javascript
// MongoDB Collections sáº½ Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng
// Hoáº·c import sample data náº¿u cÃ³

// Connect to MongoDB
use 7ty_crm_database

// Verify collections
show collections
```

### **Production Deployment (Kubernetes)**

#### **1. Environment Configuration**
```bash
# Ensure production environment variables
kubectl create secret generic app-secrets \
  --from-literal=MONGO_URL="mongodb://prod-cluster/7ty_crm" \
  --from-literal=JWT_SECRET_KEY="production-jwt-secret"
```

#### **2. Deploy Services**
```bash
# Deploy backend
kubectl apply -f k8s/backend-deployment.yaml

# Deploy frontend  
kubectl apply -f k8s/frontend-deployment.yaml

# Configure ingress
kubectl apply -f k8s/ingress.yaml
```

#### **3. Verify Deployment**
```bash
# Check service status
kubectl get pods
kubectl get services

# Check logs
kubectl logs -f deployment/backend
kubectl logs -f deployment/frontend
```

### **Supervisor Configuration (Container)**
```ini
[supervisord]
nodaemon=true

[program:backend]
command=uvicorn server:app --host 0.0.0.0 --port 8001
directory=/app/backend
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/backend.err.log
stdout_logfile=/var/log/supervisor/backend.out.log

[program:frontend]
command=yarn dev --host 0.0.0.0 --port 3000
directory=/app/frontend  
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/frontend.err.log
stdout_logfile=/var/log/supervisor/frontend.out.log
```

---

## ğŸ¯ **HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG**

### **1. ÄÄƒng Nháº­p Há»‡ Thá»‘ng**

#### **Test Accounts**
```
ğŸ”´ ADMIN: admin_test / admin123
ğŸŸ¡ MANAGER: manager_test / manager123  
ğŸŸ¢ USER: user_test / user123
```

#### **Login Process**
1. Truy cáº­p: `https://[domain]`
2. Nháº­p username/email/phone + password
3. Há»‡ thá»‘ng tá»± Ä‘á»™ng detect format Ä‘Äƒng nháº­p
4. Nháº­n JWT token vÃ  redirect vÃ o dashboard

### **2. Dashboard Overview**
- **KPI Cards**: Tá»•ng quan doanh thu, khÃ¡ch hÃ ng, giao dá»‹ch
- **Quick Actions**: 6 shortcuts nhanh
- **Revenue Charts**: Biá»ƒu Ä‘á»“ doanh thu theo thá»i gian
- **Recent Activities**: Hoáº¡t Ä‘á»™ng gáº§n Ä‘Ã¢y vá»›i customer links
- **Performance Metrics**: Metrics hiá»‡u suáº¥t há»‡ thá»‘ng

### **3. Quáº£n LÃ½ KhÃ¡ch HÃ ng**

#### **ThÃªm KhÃ¡ch HÃ ng Má»›i**
1. **Customers** â†’ **ThÃªm KhÃ¡ch HÃ ng**
2. Äiá»n thÃ´ng tin: TÃªn, SÄT, Email, Äá»‹a chá»‰
3. Chá»n loáº¡i: Individual/Agent
4. **LÆ°u** â†’ Customer Ä‘Æ°á»£c táº¡o vá»›i ID unique

#### **Customer 360Â° View**
1. Click vÃ o tÃªn khÃ¡ch hÃ ng â†’ Má»Ÿ detail page
2. **4 Tabs available**:
   - **Tá»•ng Quan**: Profile + metrics + recent activities
   - **Tháº» TÃ­n Dá»¥ng**: Quáº£n lÃ½ credit cards
   - **Giao Dá»‹ch**: Transaction history vá»›i filters
   - **PhÃ¢n TÃ­ch**: Customer analytics vÃ  insights

#### **Bulk Operations**
1. Chá»n checkbox customers
2. **Bulk Actions**: Delete hoáº·c Export Excel
3. Confirmation dialog â†’ Execute action

### **4. Quáº£n LÃ½ Bills**

#### **Kiá»ƒm Tra Bills**
1. **Kiá»ƒm Tra MÃ£ Äiá»‡n** page
2. Chá»n vÃ¹ng: Miá»n Báº¯c/Miá»n Nam/TP.HCM
3. Nháº­p customer codes (1 hoáº·c nhiá»u)
4. **Kiá»ƒm Tra** â†’ Real-time validation
5. Chá»n bills há»£p lá»‡ â†’ **ThÃªm vÃ o kho**

#### **Quáº£n LÃ½ Kho Bills**
1. **Kho Bill** page cÃ³ 2 tabs:
   - **Available**: Bills trong kho (inventory items)
   - **All Bills**: Táº¥t cáº£ bills trong há»‡ thá»‘ng
2. **Actions per tab**:
   - Available: "Bá» khá»i kho" (remove from inventory)
   - All Bills: "XÃ³a" (delete bill completely)
3. **Status management**: AVAILABLE â†’ SOLD/CROSSED

### **5. Quáº£n LÃ½ Tháº» TÃ­n Dá»¥ng**

#### **ThÃªm Tháº» Má»›i**
1. **Quáº£n LÃ½ Tháº»** â†’ **ThÃªm Tháº»**
2. Chá»n khÃ¡ch hÃ ng owner
3. ThÃ´ng tin tháº»: Sá»‘ tháº», ngÃ¢n hÃ ng, háº¡n má»©c
4. **LÆ°u** â†’ Tháº» Ä‘Æ°á»£c táº¡o vá»›i 3D UI

#### **ÄÃ¡o Tháº» (ÄÃO)**
1. Click **"ÄÃ¡o"** trÃªn tháº»
2. Chá»n phÆ°Æ¡ng thá»©c:
   - **POS**: Nháº­p sá»‘ tiá»n trá»±c tiáº¿p
   - **BILL**: Chá»n bills tá»« kho
3. Nháº­p % lá»£i nhuáº­n
4. **XÃ¡c Nháº­n** â†’ Táº¡o transaction + update status

### **6. Giao Dá»‹ch & BÃ¡o CÃ¡o**

#### **Xem Giao Dá»‹ch**
1. **Giao Dá»‹ch** page
2. **Advanced Filters**:
   - Loáº¡i: Bill Sale, Credit ÄÃO POS/BILL  
   - Thá»i gian: 7/30/90 days, Custom
   - Status: Completed/Pending/Failed
3. **Export**: Excel/PDF reports

#### **BÃ¡o CÃ¡o Analytics**
1. **BÃ¡o CÃ¡o & PhÃ¢n TÃ­ch** page
2. **Dashboard Stats**: Tá»•ng quan theo period
3. **Charts**: Revenue trends, distribution
4. **Top Customers**: Performance ranking

---

## ğŸ”§ **TROUBLESHOOTING**

### **Common Issues & Solutions**

#### **1. Login Issues**
```bash
# Problem: Cannot login
# Solution: Check credentials and JWT configuration

# Verify user exists
MongoDB: db.users.findOne({"username": "test_user"})

# Check JWT secret
Backend .env: JWT_SECRET_KEY=valid_secret_key

# Clear browser storage
localStorage.clear()
```

#### **2. API Connection Issues**
```bash
# Problem: Frontend cannot connect to backend
# Solution: Check REACT_APP_BACKEND_URL

# Frontend .env
REACT_APP_BACKEND_URL=https://correct-backend-url.com

# Verify CORS configuration
Backend server.py: app.add_middleware(CORSMiddleware, ...)
```

#### **3. Database Connection**
```bash
# Problem: Cannot connect to MongoDB
# Solution: Check MONGO_URL and MongoDB status

# Verify MongoDB running
mongod --version
mongo --eval "db.adminCommand('ismaster')"

# Check connection string
Backend .env: MONGO_URL=mongodb://correct-host:27017/db_name
```

#### **4. Permission Issues** 
```bash
# Problem: User can access unauthorized data
# Solution: Fix missing role decorators

# Add role checks to endpoints
@api_router.get("/customers") 
async def get_customers(..., current_user: dict = manager_or_admin_required):
```

#### **5. Bill Checking Fails**
```bash
# Problem: External bill API returns errors
# Solution: Check API endpoint and payload format

# Verify external API
curl -X POST https://n8n.phamthanh.net/webhook/checkbill

# Check provider mapping
MIEN_BAC â†’ mien_bac
MIEN_NAM â†’ mien_nam  
HCMC â†’ evnhcmc
```

### **Service Management Commands**
```bash
# Restart services (Kubernetes/Supervisor)
sudo supervisorctl restart backend
sudo supervisorctl restart frontend
sudo supervisorctl restart all

# Check service status
sudo supervisorctl status

# View logs
tail -f /var/log/supervisor/backend.*.log
tail -f /var/log/supervisor/frontend.*.log

# Kubernetes commands
kubectl get pods
kubectl logs -f pod/backend-xyz
kubectl restart deployment/backend
```

### **Database Maintenance**
```javascript
// MongoDB maintenance commands

// Backup database
mongodump --db 7ty_crm_database --out ./backup

// Restore database  
mongorestore --db 7ty_crm_database ./backup/7ty_crm_database

// Check indexes
db.customers.getIndexes()
db.bills.getIndexes()

// Rebuild indexes if needed
db.customers.reIndex()

// Database stats
db.stats()
db.customers.stats()
```

---

## ğŸ“Š **PERFORMANCE & MONITORING**

### **Performance Metrics**
- **Backend Response Time**: < 200ms average
- **Frontend Load Time**: < 3 seconds initial load
- **Database Query Time**: < 100ms for most queries
- **Concurrent Users**: Supports 100+ concurrent sessions
- **Memory Usage**: ~500MB backend, ~200MB frontend

### **Monitoring Setup**
```bash
# Application logs
tail -f /var/log/supervisor/backend.*.log | grep ERROR
tail -f /var/log/supervisor/frontend.*.log | grep ERROR

# Performance monitoring
# Monitor response times via backend logs
# Track memory usage via supervisor/system metrics
# Database performance via MongoDB logs

# Health check endpoints
GET /api/health â†’ Backend health
GET / â†’ Frontend health
```

### **Optimization Tips**
1. **Database Indexing**: Ensure proper indexes on frequently queried fields
2. **Caching**: Implement Redis caching for frequent database queries
3. **CDN**: Use CDN for static assets in production
4. **Code Splitting**: Implement React code splitting for better load times
5. **Database Connection Pooling**: Configure optimal connection pool size

---

## ğŸ”’ **SECURITY CONSIDERATIONS**

### **Current Security Features**
- âœ… **JWT Authentication** vá»›i bcrypt password hashing
- âœ… **CORS Protection** configured properly
- âœ… **Input Validation** via Pydantic models
- âœ… **SQL Injection Protection** (MongoDB NoSQL)
- âœ… **HTTPS Enforcement** in production
- âœ… **Session Management** with JWT expiration

### **ğŸš¨ CRITICAL SECURITY ISSUES**
```bash
# URGENT FIX NEEDED - Authorization Missing
âŒ User role has unauthorized access to ALL business data
âŒ Missing role-based access control on sensitive endpoints
âŒ Potential data breach scenario

# Required Actions:
1. Add manager_or_admin_required to all business endpoints
2. Implement proper role checking middleware
3. Test with user_test account - should get 403 Forbidden
4. Audit all endpoint permissions before production
```

### **Security Checklist**
- [ ] **Fix Role-Based Access Control** (CRITICAL)
- [ ] **Implement Rate Limiting** for API endpoints  
- [ ] **Add Request Logging** for security audit trails
- [ ] **Environment Variables Security** - no secrets in code
- [ ] **Regular Security Updates** for dependencies
- [ ] **Data Encryption** for sensitive fields (credit card numbers)
- [ ] **API Key Management** for external services
- [ ] **Backup Encryption** for database backups

---

## ğŸ“ˆ **ROADMAP & FUTURE ENHANCEMENTS**

### **Phase 1: Critical Security (Immediate)**
- ğŸš¨ **Fix Authorization System** - Add proper role-based access control
- ğŸ”’ **Security Audit** - Complete security review and fixes
- ğŸ“Š **Performance Optimization** - Database indexing and query optimization
- ğŸ§ª **Comprehensive Testing** - Unit tests, integration tests, security tests

### **Phase 2: Feature Enhancements**
- ğŸ”” **Real-time Notifications** - WebSocket integration for live updates
- ğŸ“± **Mobile Optimization** - Progressive Web App (PWA) features
- ğŸ¤– **AI Integration** - Machine learning for customer insights
- ğŸ“¤ **Advanced Exports** - PDF reports, scheduled exports
- ğŸ”„ **Workflow Automation** - Automated customer follow-ups

### **Phase 3: Scalability**
- ğŸŒ **Multi-tenancy** - Support multiple organizations
- ğŸ”— **Third-party Integrations** - More payment providers, APIs
- ğŸ“Š **Advanced Analytics** - Custom dashboards, predictive analytics
- ğŸ›¡ï¸ **Advanced Security** - Multi-factor authentication, audit logs
- ğŸš€ **Microservices Architecture** - Scalable service separation

---

## ğŸ‘¥ **SUPPORT & MAINTENANCE**

### **Documentation Updates**
- **Last Updated**: December 2024
- **Version**: 1.0.0
- **Next Review**: Q1 2025

### **Technical Support**
- **System Issues**: Check troubleshooting section first
- **Feature Requests**: Document in project backlog
- **Security Issues**: Report immediately to development team
- **Performance Issues**: Monitor logs and provide details

### **Maintenance Schedule**
- **Daily**: Monitor application logs and performance
- **Weekly**: Review security logs and user activity  
- **Monthly**: Database maintenance and backup verification
- **Quarterly**: Dependency updates and security patches

---

## ğŸ“ **CHANGELOG**

### **Version 1.0.0 (Current)**
- âœ… **Initial Release**: Complete CRM system with all core features
- âœ… **Authentication System**: JWT with role-based access (partial)
- âœ… **Customer Management**: Full CRUD with 360Â° view
- âœ… **Bill Management**: External API integration with inventory
- âœ… **Credit Card Management**: 3D UI with ÄÃO functionality
- âœ… **Transaction System**: Unified transaction management
- âœ… **Dashboard & Analytics**: Comprehensive reporting
- âš ï¸ **Known Issues**: Authorization security vulnerability

### **Upcoming Version 1.1.0**
- ğŸ”’ **Security Fix**: Complete role-based access control implementation
- ğŸš€ **Performance**: Database optimization and caching
- ğŸ“± **UI/UX**: Enhanced mobile responsiveness
- ğŸ§ª **Testing**: Comprehensive test coverage
- ğŸ“š **Documentation**: Complete API documentation

---

**Â© 2024 7ty.vn CRM System - All Rights Reserved**

*This documentation provides comprehensive guidance for system understanding, installation, configuration, and maintenance. For additional support or clarification, refer to the troubleshooting section or contact the development team.*